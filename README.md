# Python SOAP Load Tester & Verification Kit (Multiprocessing Version)

## 概要

本リポジトリは、外部の**SOAPサービス**に対して高負荷なリクエストを送信するクライアント負荷テストツールと、その受け皿となるシンプルなモックSOAPサーバーで構成されています。

### 目的

本ツールの最大の目的は、**Pythonの`multiprocessing`を活用**し、複数のリクエストが**同時的（並列）**に発行されているかを検証することです。これにより、作成した負荷テストツールがサービスの限界性能を正確に測定できるかという疑問を解消できるようにしています。

---

## 🚀 動作原理と特徴

### 1. クライアント (`pyApiAtac_mp.py`)
Pythonの**`multiprocessing`**モジュールを使用し、リクエストごとに独立したプロセスを生成します。

* **同時実行の確実性:** `multiprocessing`により、PythonのGIL（Global Interpreter Lock）の制約を回避し、複数のCPUコアを使いながら**リクエストの生成・送信処理を完全に並列**で実行します。
* **トレーサビリティ:** 各リクエストのSOAPペイロード内に、`P<プロセスID>-R<連番>`形式の識別子を埋め込みます。これにより、サーバーログやネットワークキャプチャでリクエストの追跡が容易になります。

### 2. モックサーバー (`pyMock_soap_service.py`)
Python標準ライブラリの `http.server` と `socketserver.ThreadingTCPServer` を使用したシンプルなモックSOAPサーバーです。

* **同時接続対応:** `ThreadingTCPServer`により、複数のクライアント接続（負荷ツールのプロセス）を同時に受け付け、応答します。
* **リクエストIDの検証:** クライアントから受け取った識別子をそのまま応答（レスポンス）に含めて返します。

---

## 🛠️ 実行環境とセットアップ

### 必要な環境

* Python 3.x (標準ライブラリのみを使用します)

### 実行手順

ローカルホスト（127.0.0.1:8000）でモックサービスを起動し、負荷テストを実行する手順です。

#### Step 1: モックSOAPサーバーの起動

まず、ターミナル（コンソール）を立ち上げ、モックサーバーを起動します。

```bash
python pyMock_soap_service.py
````

```
--- Mock SOAP Service Started ---
Listening on [http://127.0.0.1:8000/soap/endpoint](http://127.0.0.1:8000/soap/endpoint)
(Ctrl+C で停止)
```

#### Step 2: クライアント負荷ツールの実行

別のターミナルを立ち上げ、負荷テストツールを実行します。

```bash
python pyApiAtac_mp.py
```

`pyApiAtac_mp.py`は、設定された目標レート（デフォルト: 1000 req/sec）でリクエストを発行し始めます。

-----

## 🔬 同時アクセス検証の方法 (Wireshark)

本ツールの設計思想である「リクエストの同時発行」を検証するため、**Wireshark**などのネットワークパケットキャプチャツールを使用することを推奨します。

### 検証のポイント

1.  **キャプチャ開始:** ツール実行中に、`lo` (ループバック) インターフェースのトラフィックをキャプチャします。
2.  **フィルタリング:** HTTPの `POST /soap/endpoint` を対象にフィルタリングします。
3.  **タイムスタンプの確認:** キャプチャされた複数の `POST` リクエストの\*\*Time (秒.マイクロ秒)\*\*を確認します。

### 期待される検証結果

`multiprocessing`による同時実行が成功している場合、連続する複数のリクエストのタイムスタンプは、以下のサンプルのように**マイクロ秒単位で極めて近接**しているはずです。

| Time (秒.マイクロ秒) | Source Port |
| :--- | :--- |
| `xx:xx:xx.338274` | 61266 |
| `xx:xx:xx.338401` | 61267 |
| `xx:xx:xx.338588` | 61268 |
| `xx:xx:xx.338619` | 61265 |

**（わずか0.000345秒間に4つのリクエスト）**

この結果は、複数のプロセスが同時にリクエスト生成・送信の処理を実行しており、クライアントが**同時実行性**をもってSOAPサービスへアクセスしていることの確認が取れればOKとします。

-----

## ⚙️ 設定変更

両ファイル内の以下の定数を変更することで、接続先や負荷パラメータを調整できます。

### `pyApiAtac_mp.py` の設定

| 定数名 | 説明 | デフォルト値 |
| :--- | :--- | :--- |
| `SERVICE_HOST` | 接続先ホスト名/IP | `'127.0.0.1'` |
| `SERVICE_PORT` | 接続先ポート番号 | `8000` |
| `DURATION_SECONDS` | テスト実行時間（秒） | `10` |
| `TARGET_RATE` | 1秒間に実行したい目標リクエスト数 | `1000` |

### `pyMock_soap_service.py` の設定

| 定数名 | 説明 | デフォルト値 |
| :--- | :--- | :--- |
| `HOST` | サーバーIP | `"127.0.0.1"` |
| `PORT` | サーバーポート | `8000` |

-----

## ライセンス

本プロジェクトは自由にご利用いただけます。

```
```
